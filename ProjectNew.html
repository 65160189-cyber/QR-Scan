<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warehouse Smart Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); }
        .dark .glass-card { background: rgba(30, 41, 59, 0.8); }
        .sidebar-btn-active { background-color: #3b82f6; color: white !important; box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3); }
        .nav-btn-active { color: #3b82f6 !important; }
        .btn-primary { background-color: #3b82f6; color: white; transition: all 0.2s; }
        .btn-primary:hover { background-color: #2563eb; transform: translateY(-1px); }
        @media (min-width: 768px) { .main-content { margin-left: 280px; } }
    </style>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { colors: { primary: '#3b82f6' } } } }
    </script>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 min-h-screen transition-colors duration-300">

    <!-- Navigation สำหรับมือถือ -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 flex justify-around items-center py-3 z-50 md:hidden">
        <button onclick="showTab('dashboard')" class="flex flex-col items-center gap-1 text-slate-400 nav-btn" id="m-nav-dashboard">
            <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
            <span class="text-[10px]">หน้าหลัก</span>
        </button>
        <button onclick="showTab('stock')" class="flex flex-col items-center gap-1 text-slate-400 nav-btn" id="m-nav-stock">
            <i data-lucide="package" class="w-6 h-6"></i>
            <span class="text-[10px]">คลังสินค้า</span>
        </button>
        <button onclick="showTab('history')" class="flex flex-col items-center gap-1 text-slate-400 nav-btn" id="m-nav-history">
            <i data-lucide="history" class="w-6 h-6"></i>
            <span class="text-[10px]">ประวัติ</span>
        </button>
    </nav>

    <!-- Sidebar สำหรับ Desktop -->
    <aside class="hidden md:flex fixed left-0 top-0 bottom-0 w-[280px] bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex-col p-6 z-50">
        <div class="flex items-center gap-3 mb-10 px-2">
            <div class="bg-primary p-2.5 rounded-xl text-white shadow-lg shadow-primary/20">
                <i data-lucide="warehouse" class="w-6 h-6"></i>
            </div>
            <h1 class="font-bold text-xl tracking-tight">Warehouse Smart</h1>
        </div>
        <nav class="flex-1 space-y-2">
            <button onclick="showTab('dashboard')" id="d-nav-dashboard" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-2xl text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all font-bold">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span>หน้าหลัก Dashboard</span>
            </button>
            <button onclick="showTab('stock')" id="d-nav-stock" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-2xl text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all font-bold">
                <i data-lucide="package" class="w-5 h-5"></i>
                <span>จัดการคลัง & นำเข้า</span>
            </button>
            <button onclick="showTab('history')" id="d-nav-history" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-2xl text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all font-bold">
                <i data-lucide="history" class="w-5 h-5"></i>
                <span>ประวัติการส่ง</span>
            </button>
        </nav>
        <div class="pt-6 border-t border-slate-100 dark:border-slate-800">
            <button onclick="toggleTheme()" class="w-full flex items-center justify-between px-4 py-3.5 rounded-2xl bg-slate-50 dark:bg-slate-800 transition-all">
                <span class="text-sm font-bold">โหมดกลางคืน</span>
                <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                <i data-lucide="moon" class="w-5 h-5 block dark:hidden text-slate-400"></i>
            </button>
        </div>
    </aside>

    <main class="main-content min-h-screen p-4 md:p-10 pb-24 md:pb-10">
        <!-- DASHBOARD SECTION -->
        <section id="tab-dashboard" class="space-y-8 animate-in fade-in slide-in-from-bottom-2 duration-500">
            <div>
                <h2 class="text-4xl font-black tracking-tight">รายการจัดส่ง</h2>
                <p class="text-slate-500 text-sm mt-2" id="current-date-display"></p>
            </div>

            <!-- สรุปสถิติ -->
            <div class="grid grid-cols-2 lg:grid-cols-5 gap-5">
                <div class="glass-card p-6 rounded-[2.5rem] border border-slate-200 dark:border-slate-800 shadow-sm text-center">
                    <p class="text-slate-400 text-[10px] font-bold uppercase mb-1">ทั้งหมดวันนี้</p>
                    <h3 id="stat-total-today" class="text-4xl font-black">0</h3>
                </div>
                <div class="glass-card p-6 rounded-[2.5rem] border border-slate-200 dark:border-slate-800 shadow-sm text-center text-emerald-500">
                    <p class="text-[10px] font-bold uppercase mb-1">สำเร็จแล้ว</p>
                    <h3 id="stat-done-today" class="text-4xl font-black">0</h3>
                </div>
                <div class="glass-card p-6 rounded-[2.5rem] border border-slate-200 dark:border-slate-800 shadow-sm text-center text-orange-500">
                    <p class="text-[10px] font-bold uppercase mb-1">ค้างส่งวันนี้</p>
                    <h3 id="stat-pending-today" class="text-4xl font-black">0</h3>
                </div>
                <div class="glass-card p-6 rounded-[2.5rem] border border-slate-200 dark:border-slate-800 shadow-sm text-center text-red-500">
                    <p class="text-[10px] font-bold uppercase mb-1">งานค้างสะสม</p>
                    <h3 id="stat-delay" class="text-4xl font-black">0</h3>
                </div>
                <div class="glass-card p-6 rounded-[2.5rem] bg-primary text-white shadow-xl shadow-primary/30 col-span-2 lg:col-span-1 text-center">
                    <p class="text-white/70 text-[10px] font-bold uppercase mb-1">รวมต้องจัดส่ง</p>
                    <h3 id="stat-grand-total" class="text-4xl font-black">0</h3>
                </div>
            </div>

            <div id="dashboard-list-container" class="grid grid-cols-1 xl:grid-cols-2 gap-5"></div>
        </section>

        <!-- STOCK SECTION -->
        <section id="tab-stock" class="hidden space-y-8 animate-in fade-in duration-500">
            <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 p-8 rounded-[3rem] text-center">
                <div class="w-16 h-16 bg-primary/10 text-primary rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="upload-cloud" class="w-8 h-8"></i>
                </div>
                <h2 class="text-2xl font-bold">นำเข้าข้อมูล TGT3</h2>
                <p class="text-slate-500 text-sm mb-6 italic">เรียงลำดับ: Customer > Sale Part > Delivery Date > Order No1 > Qty</p>
                <label class="inline-flex cursor-pointer btn-primary px-10 py-4 rounded-2xl font-bold shadow-lg shadow-primary/20">
                    <span>อัปโหลด Excel</span>
                    <input type="file" id="excel-input" class="hidden" accept=".xlsx, .xls">
                </label>
                <button onclick="clearAllData()" class="block mx-auto mt-4 text-xs text-red-400 hover:underline">ล้างฐานข้อมูล</button>
            </div>

            <!-- ตารางคลังสินค้า -->
            <div class="glass-card border border-slate-200 dark:border-slate-800 rounded-[2.5rem] overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm min-w-[1000px]">
                        <thead class="bg-slate-50 dark:bg-slate-800 font-bold border-b border-slate-100 dark:border-slate-700">
                            <tr>
                                <th class="p-5">Customer</th>
                                <th class="p-5">Sale Part</th>
                                <th class="p-5">Delivery Date</th>
                                <th class="p-5">Order No1</th>
                                <th class="p-5 text-center">Shipped (ส่งแล้ว)</th>
                                <th class="p-5 text-center">Status</th>
                                <th class="p-5 text-center bg-slate-100/50 dark:bg-slate-700/50 border-l border-slate-200 dark:border-slate-600">Qty (ทั้งหมด)</th>
                            </tr>
                        </thead>
                        <tbody id="stock-table-body"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- HISTORY SECTION -->
        <section id="tab-history" class="hidden space-y-6 animate-in fade-in duration-500">
            <h2 class="text-3xl font-bold">ประวัติการทำงาน</h2>
            <div id="history-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5"></div>
        </section>
    </main>

    <!-- Modal การบันทึกส่งงาน -->
    <div id="dispatch-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-black/60 backdrop-blur-md">
        <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-[2.5rem] p-8 space-y-6 shadow-2xl">
            <div class="flex justify-between items-center">
                <h3 id="modal-customer-name" class="text-2xl font-black text-primary uppercase"></h3>
                <span id="modal-order-id" class="text-xs bg-slate-100 dark:bg-slate-800 px-3 py-1 rounded-full font-bold"></span>
            </div>
            <div class="p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700">
                <p id="modal-part-code" class="text-lg font-black text-slate-800 dark:text-slate-100"></p>
                <p id="modal-part-name" class="text-xs font-medium text-slate-400 mt-1"></p>
                <div class="flex justify-between items-end mt-4 pt-4 border-t border-slate-200 dark:border-slate-700">
                    <p class="text-sm">ยอดคงค้าง:</p>
                    <p id="modal-balance-qty" class="text-3xl font-black text-red-500"></p>
                </div>
            </div>
            <div>
                <label class="text-[10px] font-black uppercase text-slate-400 ml-2">จำนวนที่ต้องการเบิกออก</label>
                <input type="number" id="input-dispatch-qty" class="w-full bg-slate-100 dark:bg-slate-800 p-5 rounded-2xl text-3xl font-black text-center mt-1 outline-none border-4 border-transparent focus:border-primary">
            </div>
            <div class="flex gap-3">
                <button onclick="closeModal('dispatch-modal')" class="flex-1 py-4 font-bold text-slate-400">ยกเลิก</button>
                <button id="confirm-dispatch-btn" class="flex-2 btn-primary py-4 rounded-2xl font-bold px-8 shadow-lg shadow-primary/20">ยืนยันการจัดส่ง</button>
            </div>
        </div>
    </div>

    <script>
        const db = new Dexie('TGT3_Warehouse_V2');
        db.version(1).stores({
            orders: '++id, orderId, customer, date, partCode, partName, qty, shippedQty, status',
            history: '++id, orderId, timestamp, qty, partCode'
        });

        const todayStr = new Date().toISOString().split('T')[0];
        document.getElementById('current-date-display').innerText = new Date().toLocaleDateString('th-TH', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

        function toggleTheme() { document.documentElement.classList.toggle('dark'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        async function updateDashboard() {
            const all = await db.orders.toArray();
            const todayRows = all.filter(o => o.date === todayStr);
            const doneToday = todayRows.filter(o => o.status === 'จัดส่งแล้ว');
            const pendingToday = todayRows.filter(o => o.status !== 'จัดส่งแล้ว');
            const delay = all.filter(o => o.date < todayStr && o.status !== 'จัดส่งแล้ว');

            document.getElementById('stat-total-today').innerText = todayRows.length;
            document.getElementById('stat-done-today').innerText = doneToday.length;
            document.getElementById('stat-pending-today').innerText = pendingToday.length;
            document.getElementById('stat-delay').innerText = delay.length;
            document.getElementById('stat-grand-total').innerText = pendingToday.length + delay.length;

            const listContainer = document.getElementById('dashboard-list-container');
            const targetList = [...delay, ...pendingToday];

            if (targetList.length === 0) {
                listContainer.innerHTML = `<div class="col-span-full p-20 text-center text-slate-400 font-bold border-2 border-dashed border-slate-200 dark:border-slate-800 rounded-3xl">ไม่มีรายการที่ต้องจัดส่งในขณะนี้</div>`;
            } else {
                listContainer.innerHTML = targetList.map(o => `
                    <div class="glass-card p-6 rounded-[2.5rem] border border-slate-200 dark:border-slate-800 flex flex-col gap-4 shadow-sm hover:scale-[1.01] transition-all">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-black text-xl text-primary uppercase">${o.customer}</h4>
                                <p class="text-xs font-bold text-slate-500">กำหนดส่ง: ${o.date}</p>
                            </div>
                            <div class="text-right">
                                <span class="text-[9px] font-black px-2 py-0.5 rounded-md ${o.date < todayStr ? 'bg-red-500' : 'bg-blue-500'} text-white uppercase">${o.date < todayStr ? 'ค้างส่งสะสม' : 'จัดส่งวันนี้'}</span>
                            </div>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border border-slate-100 dark:border-slate-700">
                            <p class="text-lg font-black">${o.partCode}</p>
                            <p class="text-[10px] text-slate-400 font-medium truncate">${o.partName}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                             <div class="bg-slate-100 dark:bg-slate-800 p-3 rounded-xl">
                                <p class="text-[8px] font-black text-slate-400 uppercase">Order No1</p>
                                <p class="font-bold text-sm truncate">#${o.orderId}</p>
                             </div>
                             <div class="bg-slate-100 dark:bg-slate-800 p-3 rounded-xl border-l-4 border-primary shadow-inner">
                                <p class="text-[8px] font-black text-primary uppercase text-right">Qty (จำนวน)</p>
                                <p class="font-black text-2xl text-right">${o.qty}</p>
                             </div>
                        </div>
                        <div class="flex items-center justify-between px-2">
                             <span class="text-[10px] font-bold text-emerald-500">ส่งแล้ว: ${o.shippedQty || 0}</span>
                             <span class="text-[10px] font-bold text-red-500">คงเหลือ: ${o.qty - (o.shippedQty || 0)}</span>
                        </div>
                        <button onclick="openDispatchModal(${o.id})" class="btn-primary py-4 rounded-2xl font-black text-sm tracking-wide">จัดการเบิก/ส่งของ</button>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        async function openDispatchModal(id) {
            const order = await db.orders.get(id);
            const balance = order.qty - (order.shippedQty || 0);
            document.getElementById('modal-customer-name').innerText = order.customer;
            document.getElementById('modal-order-id').innerText = order.orderId;
            document.getElementById('modal-part-code').innerText = order.partCode;
            document.getElementById('modal-part-name').innerText = order.partName;
            document.getElementById('modal-balance-qty').innerText = balance;
            document.getElementById('input-dispatch-qty').value = balance;
            document.getElementById('confirm-dispatch-btn').onclick = () => executeDispatch(id);
            document.getElementById('dispatch-modal').classList.remove('hidden');
        }

        async function executeDispatch(id) {
            const qtyInput = parseInt(document.getElementById('input-dispatch-qty').value);
            const order = await db.orders.get(id);
            if (!qtyInput || qtyInput <= 0 || qtyInput > (order.qty - order.shippedQty)) return;
            
            const newShipped = order.shippedQty + qtyInput;
            const finalStatus = newShipped >= order.qty ? 'จัดส่งแล้ว' : 'ส่งบางส่วน';
            
            await db.orders.update(id, { shippedQty: newShipped, status: finalStatus });
            await db.history.add({ orderId: order.orderId, partCode: order.partCode, qty: qtyInput, timestamp: new Date().toISOString() });
            
            closeModal('dispatch-modal');
            updateDashboard();
        }

        async function updateStockTable() {
            const all = await db.orders.toArray();
            const tbody = document.getElementById('stock-table-body');
            tbody.innerHTML = all.reverse().map(o => `
                <tr class="border-b border-slate-50 dark:border-slate-800 hover:bg-slate-50/50">
                    <td class="p-5 font-black text-primary uppercase">${o.customer}</td>
                    <td class="p-5">
                        <div class="font-bold text-sm">${o.partCode}</div>
                        <div class="text-[10px] text-slate-400 truncate w-40">${o.partName}</div>
                    </td>
                    <td class="p-5 font-bold text-slate-500">${o.date}</td>
                    <td class="p-5 font-bold">#${o.orderId}</td>
                    <td class="p-5 text-center font-black text-emerald-500">${o.shippedQty}</td>
                    <td class="p-5 text-center">
                        <span class="px-3 py-1 rounded-full text-[9px] font-black ${o.status === 'จัดส่งแล้ว' ? 'bg-emerald-100 text-emerald-600' : 'bg-blue-100 text-blue-600'}">
                            ${o.status}
                        </span>
                    </td>
                    <td class="p-5 text-center font-black bg-slate-100/30 dark:bg-slate-800/50 text-xl border-l border-slate-200 dark:border-slate-700">${o.qty}</td>
                </tr>
            `).join('');
        }

        async function renderHistory() {
            const logs = await db.history.orderBy('id').reverse().toArray();
            const container = document.getElementById('history-container');
            container.innerHTML = logs.map(l => `
                <div class="p-5 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-3xl flex justify-between items-center shadow-sm">
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold">${new Date(l.timestamp).toLocaleTimeString()}</p>
                        <p class="font-black text-lg">#${l.orderId}</p>
                        <p class="text-xs font-bold text-primary">${l.partCode}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] font-black text-emerald-500 uppercase">เบิกออกแล้ว</p>
                        <p class="text-2xl font-black text-emerald-600">${l.qty}</p>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function showTab(tab) {
            ['dashboard', 'stock', 'history'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.add('hidden');
                document.getElementById(`d-nav-${t}`).classList.remove('sidebar-btn-active');
                document.getElementById(`m-nav-${t}`).classList.remove('nav-btn-active');
            });
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            document.getElementById(`d-nav-${tab}`).classList.add('sidebar-btn-active');
            document.getElementById(`m-nav-${tab}`).classList.add('nav-btn-active');
            if (tab === 'dashboard') updateDashboard();
            if (tab === 'stock') updateStockTable();
            if (tab === 'history') renderHistory();
            lucide.createIcons();
        }

        async function clearAllData() { if(confirm("ต้องการล้างข้อมูลทั้งหมดใช่หรือไม่?")) { await db.orders.clear(); await db.history.clear(); updateStockTable(); } }

        document.getElementById('excel-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = async function(event) {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames.find(n => n.toUpperCase().includes("TGT3")) || workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                let colMap = { customer: -1, partCode: -1, partName: -1, date: -1, qty: -1, order: -1 };
                let headerIdx = -1;

                for (let i = 0; i < Math.min(rows.length, 20); i++) {
                    const row = rows[i];
                    if (!row) continue;
                    row.forEach((cell, idx) => {
                        const txt = String(cell || "").toUpperCase().trim();
                        if (txt === "CUSTOMER") colMap.customer = idx;
                        if (txt === "SALE PART") colMap.partCode = idx;
                        if (txt === "PART NAME") colMap.partName = idx;
                        if (txt === "DELIVERY DATE") colMap.date = idx;
                        if (txt === "QTY") colMap.qty = idx;
                        if (txt === "ORDER NO1") colMap.order = idx;
                    });
                    if (colMap.order !== -1) { headerIdx = i; break; }
                }

                if (headerIdx === -1) return alert("ไม่พบคอลัมน์ Order No1 ในไฟล์ที่อัปโหลด กรุณาตรวจสอบรูปแบบไฟล์");

                let imported = 0;
                for (let i = headerIdx + 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (!row || !row[colMap.order]) continue;

                    let dDate = row[colMap.date];
                    if (typeof dDate === 'number') {
                        dDate = new Date((dDate - 25569) * 86400 * 1000).toISOString().split('T')[0];
                    }

                    await db.orders.add({
                        orderId: String(row[colMap.order]),
                        customer: String(row[colMap.customer] || "N/A"),
                        date: dDate || todayStr,
                        partCode: String(row[colMap.partCode] || "-"),
                        partName: String(row[colMap.partName] || "N/A"),
                        qty: parseInt(row[colMap.qty]) || 0,
                        shippedQty: 0,
                        status: 'อยู่ในคลัง' // เปลี่ยนค่าเริ่มต้นเป็น "อยู่ในคลัง"
                    });
                    imported++;
                }
                alert(`นำเข้าข้อมูลจาก Sheet ${sheetName} สำเร็จ ${imported} รายการ สถานะเริ่มต้นเป็น 'อยู่ในคลัง'`);
                showTab('dashboard');
            };
            reader.readAsArrayBuffer(file);
            e.target.value = '';
        });

        window.onload = () => showTab('dashboard');
    </script>
</body>
</html>